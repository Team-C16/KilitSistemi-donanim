name: Build & Release (ARMv6 + ARM64)

on:
  push:
    tags:
      - 'v*' # Sadece v1.0.0, v2.3.5 gibi tag atÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r

permissions:
  contents: write # Release oluÅŸturmak iÃ§in ÅŸart

jobs:
  build-matrix:
    name: Build ${{ matrix.arch_name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # --- Raspberry Pi Zero / 1 (32-bit) ---
          - arch_name: "ARMv6"
            docker_platform: "linux/arm/v6"
            base_image: "balenalib/raspberry-pi-debian:bullseye-build"
            go_arch: "arm"
            go_arm: "6"
            go_dl_arch: "armv6l"
            suffix: "armv6"
            
          # --- Raspberry Pi 3 / 4 / 5 / Zero 2 (64-bit) ---
          - arch_name: "ARM64"
            docker_platform: "linux/arm64"
            base_image: "balenalib/aarch64-debian:bullseye-build"
            go_arch: "arm64"
            go_arm: "" # 64-bit iÃ§in boÅŸ bÄ±rakÄ±lÄ±r
            go_dl_arch: "arm64"
            suffix: "arm64"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ”¨ Building version: $VERSION for ${{ matrix.arch_name }}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.docker_platform }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build inside Docker (CGO Support)
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          BINARY_NAME="DonanimGO-${VERSION}-${{ matrix.suffix }}"
          
          # Dockerfile'Ä± dinamik oluÅŸturuyoruz (Her mimari iÃ§in uygun base image ile)
          cat > Dockerfile <<EOF
          FROM ${{ matrix.base_image }}
          
          # Gerekli kÃ¼tÃ¼phaneler (Fyne/GLES vb.)
          RUN apt-get update && apt-get install -y --no-install-recommends \\
              wget ca-certificates git pkg-config \\
              libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev \\
              libx11-dev libxcursor-dev libxrandr-dev \\
              libxinerama-dev libxi-dev libxxf86vm-dev \\
              && rm -rf /var/lib/apt/lists/*

          # Go Kurulumu (Mimariye Ã¶zel)
          RUN wget -q https://go.dev/dl/go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz \\
              && tar -C /usr/local -xzf go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz \\
              && rm go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz

          ENV PATH="/usr/local/go/bin:\${PATH}"
          ENV CGO_ENABLED=1
          ENV GOOS=linux
          ENV GOARCH=${{ matrix.go_arch }}
          ENV GOARM=${{ matrix.go_arm }}

          WORKDIR /app
          COPY GOLang-Deneme/ .

          # Config iÃ§indeki versiyonu gÃ¼ncelle (Opsiyonel)
          RUN sed -i "s/var Version = \"v0.0.0-dev\"/var Version = \"${VERSION}\"/" internal/config/config.go || true
          
          # Build komutu
          RUN mkdir -p /output && go build -tags gles -ldflags="-s -w" -o /output/${BINARY_NAME} ./cmd/kiosk
          EOF

          # Build BaÅŸlat
          docker buildx build \
            --platform ${{ matrix.docker_platform }} \
            --load \
            -t builder-img \
            -f Dockerfile .

          # Binary dosyasÄ±nÄ± dÄ±ÅŸarÄ± al
          docker create --name extract builder-img
          docker cp extract:/output/${BINARY_NAME} ./${BINARY_NAME}
          docker rm extract
          
          # Checksum oluÅŸtur (Manuel kontrol iÃ§in dursun)
          sha256sum ${BINARY_NAME} > ${BINARY_NAME}.sha256

      - name: Upload Artifact (Temporary)
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: |
            DonanimGO-*
            *.sha256
          retention-days: 1

  # --- RELEASE JOB ---
  create-release:
    needs: build-matrix
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Artifacts klasÃ¶r yapÄ±sÄ±nÄ± dÃ¼zeltip tek bir yere topluyoruz
      - name: Prepare Release Files
        run: |
          mkdir release_files
          find artifacts -name "DonanimGO-*" -exec cp {} release_files/ \;
          find artifacts -name "*.sha256" -exec cp {} release_files/ \;
          ls -R release_files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}