name: Go Build - Raspberry Pi

on:
  push:
    branches: [ main, master ]
    paths:
      - 'GOLang-Deneme/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'GOLang-Deneme/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./GOLang-Deneme

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version from commit message
      id: version
      run: |
        # Commit mesajından versiyon çıkar (örnek: "v1.2.3" veya "release v1.0.0")
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        VERSION=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
        
        if [ -z "$VERSION" ]; then
          echo "❌ ERROR: Commit mesajında versiyon bulunamadı!"
          echo "Commit mesajında vX.X.X formatında versiyon belirtmelisiniz."
          echo "Örnek: 'v1.0.0 - Initial release' veya 'Feature update v1.2.3'"
          exit 1
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "✅ Building version: $VERSION"

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        cache-dependency-path: GOLang-Deneme/go.sum

    - name: Download Go modules
      run: go mod download

    - name: Install fyne-cross
      run: go install github.com/fyne-io/fyne-cross@latest

    - name: Set version in config
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        # Update the Version variable in config.go
        sed -i "s/var Version = \"v0.0.0-dev\"/var Version = \"${VERSION}\"/" internal/config/config.go
        echo "✅ Version set to: ${VERSION}"
        grep "var Version" internal/config/config.go

    - name: Build for Raspberry Pi (arm64 & armv6)
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        
        # Build ARM64
        OUTPUT_64="DonanimGO-${VERSION}-arm64"
        ~/go/bin/fyne-cross linux -arch=arm64 -name "$OUTPUT_64" ./cmd/kiosk
        cp ./fyne-cross/bin/linux-arm64/kiosk ./"$OUTPUT_64"
        
        # Build ARMv6 (Raspberry Pi Zero W / 1 için DÜZELTİLMİŞ HALİ)
        OUTPUT_V6="DonanimGO-${VERSION}-armv6"
        
        # DİKKAT: CGO_CFLAGS ekliyoruz. Listedeki tam ismi (arm1176jzf_s) boşluksuz kullanıyoruz.
        ~/go/bin/fyne-cross linux -arch arm -env GOARM=6 -env CGO_CFLAGS="-mcpu=arm1176jzf_s" -name "$OUTPUT_V6" ./cmd/kiosk
        
        cp ./fyne-cross/bin/linux-arm/kiosk ./"$OUTPUT_V6"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: DonanimGO-${{ steps.version.outputs.VERSION }}-binaries
        path: |
          GOLang-Deneme/DonanimGO-${{ steps.version.outputs.VERSION }}-arm64
          GOLang-Deneme/DonanimGO-${{ steps.version.outputs.VERSION }}-armv6
        retention-days: 90
