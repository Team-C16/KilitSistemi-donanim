name: Build & Release (Commit Msg)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'GOLang-Deneme/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'GOLang-Deneme/**'

permissions:
  contents: write # Release oluÅŸturmak iÃ§in ÅŸart

jobs:
  # 1. VERSÄ°YON BELÄ°RLEME (SENÄ°N MANTIÄžIN)
  setup:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      SHOULD_RELEASE: ${{ steps.version.outputs.SHOULD_RELEASE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Commit Message
        id: version
        run: |
          # Senin grep mantÄ±ÄŸÄ±n:
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
          
          if [ -n "$VERSION" ]; then
            echo "ðŸŽ‰ Version found in commit: $VERSION"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            echo "SHOULD_RELEASE=true" >> $GITHUB_OUTPUT
          else
            DEV_VERSION="v0.0.0-$(git rev-parse --short HEAD)"
            echo "âš ï¸ No version in commit, using dev: $DEV_VERSION"
            echo "VERSION=$DEV_VERSION" >> $GITHUB_OUTPUT
            echo "SHOULD_RELEASE=false" >> $GITHUB_OUTPUT
          fi

  # 2. BUILD Ä°ÅžLEMÄ° (ARMv6 ve ARM64)
  build-matrix:
    needs: setup
    name: Build ${{ matrix.arch_name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # --- Raspberry Pi Zero / 1 (32-bit) ---
          - arch_name: "ARMv6"
            docker_platform: "linux/arm/v6"
            base_image: "balenalib/raspberry-pi-debian:bullseye-build"
            go_arch: "arm"
            go_arm: "6"
            go_dl_arch: "armv6l"
            suffix: "armv6"
            
          # --- Raspberry Pi 3 / 4 / 5 / Zero 2 (64-bit) ---
          - arch_name: "ARM64"
            docker_platform: "linux/arm64"
            base_image: "balenalib/aarch64-debian:bullseye-build"
            go_arch: "arm64"
            go_arm: "" # 64-bit iÃ§in boÅŸ
            go_dl_arch: "arm64"
            suffix: "arm64"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.docker_platform }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build inside Docker (CGO Support)
        run: |
          # Setup job'Ä±ndan gelen versiyonu alÄ±yoruz
          VERSION="${{ needs.setup.outputs.VERSION }}"
          BINARY_NAME="DonanimGO-${VERSION}-${{ matrix.suffix }}"
          
          echo "ðŸ”¨ Building $BINARY_NAME inside Docker..."

          # Dockerfile'Ä± dinamik oluÅŸturuyoruz
          cat > Dockerfile <<EOF
          FROM ${{ matrix.base_image }}
          
          # Gerekli kÃ¼tÃ¼phaneler (Fyne/GLES vb.)
          RUN apt-get update && apt-get install -y --no-install-recommends \\
              wget ca-certificates git pkg-config \\
              libgl1-mesa-dev libegl1-mesa-dev libgles2-mesa-dev \\
              libx11-dev libxcursor-dev libxrandr-dev \\
              libxinerama-dev libxi-dev libxxf86vm-dev \\
              && rm -rf /var/lib/apt/lists/*

          # Go Kurulumu
          RUN wget -q https://go.dev/dl/go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz \\
              && tar -C /usr/local -xzf go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz \\
              && rm go1.21.13.linux-${{ matrix.go_dl_arch }}.tar.gz

          ENV PATH="/usr/local/go/bin:\${PATH}"
          ENV CGO_ENABLED=1
          ENV GOOS=linux
          ENV GOARCH=${{ matrix.go_arch }}
          ENV GOARM=${{ matrix.go_arm }}

          WORKDIR /app
          COPY GOLang-Deneme/ .

          # Config iÃ§indeki versiyonu gÃ¼ncelle (Senin sed komutun)
          RUN sed -i "s/var Version = \"v0.0.0-dev\"/var Version = \"${VERSION}\"/" internal/config/config.go || true
          
          # Build komutu
          RUN mkdir -p /output && go build -tags gles -ldflags="-s -w" -o /output/${BINARY_NAME} ./cmd/kiosk
          EOF

          # Build BaÅŸlat
          docker buildx build \
            --platform ${{ matrix.docker_platform }} \
            --load \
            -t builder-img \
            -f Dockerfile .

          # Binary dosyasÄ±nÄ± dÄ±ÅŸarÄ± al
          docker create --name extract builder-img
          docker cp extract:/output/${BINARY_NAME} ./${BINARY_NAME}
          docker rm extract
          
          # Checksum oluÅŸtur
          sha256sum ${BINARY_NAME} > ${BINARY_NAME}.sha256
          
          # Bilgi ver
          ls -lh ${BINARY_NAME}
          file ${BINARY_NAME}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: |
            DonanimGO-*
            *.sha256
          retention-days: 5

  # 3. RELEASE OLUÅžTURMA (SADECE COMMIT MESAJINDA VERSÄ°YON VARSA)
  create-release:
    needs: [setup, build-matrix]
    if: needs.setup.outputs.SHOULD_RELEASE == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir release_files
          find artifacts -name "DonanimGO-*" -exec cp {} release_files/ \;
          find artifacts -name "*.sha256" -exec cp {} release_files/ \;
          ls -R release_files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.VERSION }} # Commit mesajÄ±ndaki versiyonu tag olarak kullanÄ±r
          name: Release ${{ needs.setup.outputs.VERSION }}
          draft: false
          prerelease: false
          files: release_files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}